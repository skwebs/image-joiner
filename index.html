<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aadhaar Image Joiner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex p-2 sm:p-4">
    <!-- Sidebar Backdrop (visible when sidebar is open on mobile) -->
    <div id="sidebarBackdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden sm:hidden z-10"></div>

    <!-- Sidebar -->
    <div id="sidebar"
        class="fixed inset-y-0 left-0 w-40 sm:w-48 bg-white shadow-lg transform -translate-x-full sm:translate-x-0 transition-transform duration-300 ease-in-out z-20">
        <div class="p-3 sm:p-4">
            <h2 class="text-sm sm:text-base font-semibold mb-3 sm:mb-4">Settings</h2>
            <div class="space-y-2">
                <h3 class="text-xs sm:text-sm font-medium">Layout</h3>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="layout" value="vertical" checked class="text-blue-500">
                    <span class="text-xs sm:text-sm">Vertical</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="layout" value="horizontal" class="text-blue-500">
                    <span class="text-xs sm:text-sm">Horizontal</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 max-w-xl w-full mx-auto z-0 sm:ml-48">
        <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h1 class="text-lg sm:text-xl font-bold">Aadhaar Image Joiner</h1>
                <button type="button" id="toggleSidebar" class="sm:hidden text-blue-500">
                    <span class="sr-only">Toggle sidebar</span>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <!-- Image Upload -->
            <div class="space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Front Image Upload -->
                    <div class="flex flex-col items-center">
                        <label for="frontImage" class="block text-xs font-medium text-gray-700 mb-1">Front Image</label>
                        <input type="file" id="frontImage" accept="image/*" class="w-full p-1 border rounded text-xs">
                        <img id="frontPreview" class="mt-1 max-w-full h-32 sm:h-40 object-contain hidden rounded"
                            alt="Front Preview">
                        <button type="button" id="cropFrontBtn"
                            class="mt-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 hidden">Crop
                            Front</button>
                    </div>

                    <!-- Back Image Upload -->
                    <div class="flex flex-col items-center">
                        <label for="backImage" class="block text-xs font-medium text-gray-700 mb-1">Back Image</label>
                        <input type="file" id="backImage" accept="image/*" class="w-full p-1 border rounded text-xs">
                        <img id="backPreview" class="mt-1 max-w-full h-32 sm:h-40 object-contain hidden rounded"
                            alt="Back Preview">
                        <button type="button" id="cropBackBtn"
                            class="mt-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 hidden">Crop
                            Back</button>
                    </div>
                </div>
            </div>

            <!-- Combined Image Preview -->
            <div class="mt-3 sm:mt-4">
                <h2 class="text-sm sm:text-base font-semibold text-center mb-1">Combined Image Preview</h2>
                <canvas id="combinedCanvas" class="max-w-full h-auto mx-auto rounded border hidden"></canvas>
            </div>

            <!-- Action Buttons -->
            <div class="mt-3 sm:mt-4 text-center">
                <button type="button" id="combineBtn"
                    class="bg-blue-500 text-white px-3 py-1 rounded text-xs sm:text-sm hover:bg-blue-600 disabled:bg-gray-400"
                    disabled>Combine & Preview</button>
                <a id="downloadLink"
                    class="bg-green-500 text-white px-3 py-1 rounded text-xs sm:text-sm hover:bg-green-600 ml-2 hidden"
                    href="#" download="combined_aadhaar.jpg">Download</a>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30">
        <div class="bg-white rounded-lg p-3 w-full max-w-sm mx-2 max-h-[85vh] overflow-y-auto">
            <h2 id="cropModalTitle" class="text-base font-semibold mb-3">Crop Image</h2>
            <div class="relative w-full h-48 sm:h-64">
                <img id="cropImage" class="w-full h-full object-contain" alt="Crop Image">
            </div>
            <div class="mt-3 flex justify-end space-x-2">
                <button type="button" id="cancelCropBtn"
                    class="bg-gray-300 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-400">Cancel</button>
                <button type="button" id="saveCropBtn"
                    class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">Save
                    Crop</button>
            </div>
        </div>
    </div>

    <script>
        const frontImageInput = document.getElementById('frontImage');
        const backImageInput = document.getElementById('backImage');
        const frontPreview = document.getElementById('frontPreview');
        const backPreview = document.getElementById('backPreview');
        const cropFrontBtn = document.getElementById('cropFrontBtn');
        const cropBackBtn = document.getElementById('cropBackBtn');
        const combinedCanvas = document.getElementById('combinedCanvas');
        const combineBtn = document.getElementById('combineBtn');
        const downloadLink = document.getElementById('downloadLink');
        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const saveCropBtn = document.getElementById('saveCropBtn');
        const cropModalTitle = document.getElementById('cropModalTitle');
        const layoutRadios = document.getElementsByName('layout');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');
        const ctx = combinedCanvas.getContext('2d');

        let frontImg = null;
        let backImg = null;
        let cropper = null;
        let currentCropTarget = null;

        // Aadhaar aspect ratio (86mm x 54mm)
        const aadhaarAspectRatio = 86 / 54; // ~1.59
        // Standard size for combined images (in pixels)
        const standardWidth = 600;
        const standardHeight = Math.round(standardWidth / aadhaarAspectRatio);
        // Gap between images (in pixels)
        const gap = 10;

        // Load saved layout from localStorage
        const savedLayout = localStorage.getItem('layout') || 'vertical';
        layoutRadios.forEach(radio => {
            if (radio.value === savedLayout) radio.checked = true;
        });

        // Toggle sidebar and backdrop on mobile
        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarBackdrop.classList.toggle('hidden');
        });

        // Close sidebar and backdrop when clicking backdrop
        sidebarBackdrop.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebarBackdrop.classList.add('hidden');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !toggleSidebar.contains(e.target) && !sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
                sidebarBackdrop.classList.add('hidden');
            }
        });

        // Handle front image upload
        frontImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                frontImg = new Image();
                frontImg.onload = () => {
                    frontPreview.src = frontImg.src;
                    frontPreview.classList.remove('hidden');
                    cropFrontBtn.classList.remove('hidden');
                    checkImagesLoaded();
                };
                frontImg.src = URL.createObjectURL(file);
            }
        });

        // Handle back image upload
        backImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                backImg = new Image();
                backImg.onload = () => {
                    backPreview.src = backImg.src;
                    backPreview.classList.remove('hidden');
                    cropBackBtn.classList.remove('hidden');
                    checkImagesLoaded();
                };
                backImg.src = URL.createObjectURL(file);
            }
        });

        // Enable combine button when both images are loaded
        function checkImagesLoaded() {
            if (frontImg && backImg) {
                combineBtn.disabled = false;
                // Auto-combine if preview is already visible
                if (!combinedCanvas.classList.contains('hidden')) {
                    combineImages();
                }
            }
        }

        // Open crop modal for front image
        cropFrontBtn.addEventListener('click', () => {
            currentCropTarget = 'front';
            cropModalTitle.textContent = 'Crop Front Image';
            cropImage.src = frontPreview.src;
            cropModal.classList.remove('hidden');
            initCropper();
        });

        // Open crop modal for back image
        cropBackBtn.addEventListener('click', () => {
            currentCropTarget = 'back';
            cropModalTitle.textContent = 'Crop Back Image';
            cropImage.src = backPreview.src;
            cropModal.classList.remove('hidden');
            initCropper();
        });

        // Initialize Cropper.js
        function initCropper() {
            if (cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
                aspectRatio: aadhaarAspectRatio,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
            });
        }

        // Cancel crop
        cancelCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            if (cropper) cropper.destroy();
        });

        // Save cropped image
        saveCropBtn.addEventListener('click', () => {
            if (cropper) {
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: standardWidth,
                    height: standardHeight,
                });
                const croppedImage = new Image();
                croppedImage.onload = () => {
                    if (currentCropTarget === 'front') {
                        frontImg = croppedImage;
                        frontPreview.src = croppedImage.src;
                    } else {
                        backImg = croppedImage;
                        backPreview.src = croppedImage.src;
                    }
                    cropModal.classList.add('hidden');
                    cropper.destroy();
                    checkImagesLoaded();
                };
                croppedImage.src = croppedCanvas.toDataURL('image/jpeg');
            }
        });

        // Combine images function
        function combineImages() {
            const layout = Array.from(layoutRadios).find(radio => radio.checked).value;

            // Resize images to standard size
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = standardWidth;
            tempCanvas.height = standardHeight;
            const tempCtx = tempCanvas.getContext('2d');

            // Resize front image
            const frontResized = new Image();
            frontResized.src = frontImg.src;
            tempCtx.drawImage(frontResized, 0, 0, standardWidth, standardHeight);
            const frontResizedData = tempCanvas.toDataURL('image/jpeg');
            frontResized.src = frontResizedData;

            // Resize back image
            const backResized = new Image();
            backResized.src = backImg.src;
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(backResized, 0, 0, standardWidth, standardHeight);
            const backResizedData = tempCanvas.toDataURL('image/jpeg');
            backResized.src = backResizedData;

            // Wait for resized images to load
            Promise.all([
                new Promise(resolve => frontResized.onload = resolve),
                new Promise(resolve => backResized.onload = resolve),
            ]).then(() => {
                // Set canvas dimensions based on layout, including gap
                let canvasWidth, canvasHeight;
                if (layout === 'vertical') {
                    canvasWidth = standardWidth;
                    canvasHeight = standardHeight * 2 + gap;
                } else {
                    canvasWidth = standardWidth * 2 + gap;
                    canvasHeight = standardHeight;
                }

                // Set canvas size
                combinedCanvas.width = canvasWidth;
                combinedCanvas.height = canvasHeight;
                combinedCanvas.classList.remove('hidden');

                // Clear canvas and set background (white for clarity)
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                // Draw images based on layout with gap
                if (layout === 'vertical') {
                    ctx.drawImage(frontResized, 0, 0, standardWidth, standardHeight);
                    ctx.drawImage(backResized, 0, standardHeight + gap, standardWidth, standardHeight);
                } else {
                    ctx.drawImage(frontResized, 0, 0, standardWidth, standardHeight);
                    ctx.drawImage(backResized, standardWidth + gap, 0, standardWidth, standardHeight);
                }

                // Generate download link
                downloadLink.href = combinedCanvas.toDataURL('image/jpeg');
                downloadLink.classList.remove('hidden');
            });
        }

        // Combine images on button click
        combineBtn.addEventListener('click', combineImages);

        // Update preview and save layout when layout changes
        layoutRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                localStorage.setItem('layout', radio.value);
                if (frontImg && backImg && !combinedCanvas.classList.contains('hidden')) {
                    combineImages();
                }
            });
        });
    </script>
</body>

</html>